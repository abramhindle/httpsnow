<!doctype html>
<html>
  <head>
    <title>Magic!</title>
    <style>
#multibuttonpanel {
        width: 100%;
       height: 25%;
}
#sliderpanel {
        width: 100%;
       height: 75%;
}


html, body {
   height: 100%;
   width: 100%;
   margin: 0;
   padding: 0;
}
</style>
        <script src="./www.charlie-roberts.com/interface/build/interface.js"></script>

    <script src="./gibberish3.js"></script>
  </head>
    <body>
    <div id="multibuttonpanel">
    </div>
    <div id="sliderpanel">
    </div>
    <script>
/* Some ideas were taken from

 * Mozilla https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia

*/

g = Gibberish.genish

/* From Charlie Roberts */

Gibberish.Var = initialValue => {
  const ugen = Object.create( Gibberish.prototypes.ugen )
  
  const graph = g.param( initialValue )
  
  return Gibberish.factory( ugen, graph, 'var' )
}


b = null;


window.addEventListener("load", function() {
    console.log("onload");
    Gibberish.init();
    q = Gibberish.Var(0.0);
    
    var trumpet = Gibberish.instruments.Sampler({
        filename:'./www.charlie-roberts.com/gibberish/resources/trumpet.wav'
    });
    trumpet.onload = function() {
        trumpet.loops = 1;
        /*
        b = Gibberish.fx.Shuffler({ 
            input:trumpet,
            rate:2205,
            reverseChance:.5,
            repitchChance: .5,
            repitchMin: 0.25,
            repitchMax: 5.0,
            mix:1
        });*/
        //b.connect();
        trumpet.note(1);
        b = trumpet;
        k = Bus();
        minv = Gibberish.Var(200);
        var modulator = Sine({frequency:10.0,gain:20});
        e = Sine({
            frequency:Add(Add(20,minv),
                          q,
                          Sine({
                              frequency:Add(21, modulator), //Sine Freq
                              gain:minv
                          })
                         ),
            gain:100.0
        }); //e.gain
        //clipSine = Clamp({input:e,min:-0.2,max:0.2}).connect(k);
        clipSine = Clamp(e,-0.05,0.05).connect(k);        
        clipMul = Gibberish.binops.Mul(b,q);        
        clampGrain = Clamp(clipMul ,-0.5,0.5);
        clampMul = Gibberish.binops.Mul(clampGrain,1.0);
        // why connect is missing?
        Gibberish.output.inputs.push( clampMul );
        //k.push( clampMul );
        k.connect();
        console.log("connected");
        
        
        //setupSliders(clipMul,clampMul,e);
        var sliderDef = [
            {target: q,
             name:"q",
             key: "value",
             min: 0.0,
             max: 100.0
            },
            {target: clipMul,
             name:"Clip Mul",
             key: 1,
             min: 0.0,
             max: 1000
            },
            /*
            {target: clampGrain,
             name:"GrainClampMin",
             key: "min",
             min: -1.0,
             max: -0.5,
            },
            {target: clampGrain,
             name:"GrainClampMax",
             key: "max",
             min: 0.0,
             max: 1.0,
            },
            {target: b,
             key: "amp",
             min: 0,
             max: 2,
            },
            {target: b,
             key: "speed",
             min: 0.01,
             max: 10,
            },
            {target: b,
             key: "grainSize",
             min: 10,
             max: 2000,
            },
            {target: b,
             key: "position",
             min: 0,
             max: 1,
            },
            */ 
            {target: e,
             key: "amp",
             name: "sineamp",
             min: 0,
             max: 1000,
            },
            //minv = new Gibberish.Step(1.0,200);
            {target: minv,
             key: "value",
             name: "CenterFreq",
             min: 20,
             max: 1000,
            },
            //var modulator = new Gibberish.Sine(10.0,20);
            {target: modulator,
             key: "frequency",
             name: "FRange",
             min: 0.1,
             max: 40,
            },
            {target: modulator,
             key: "amp",
             name: "FAmp",
             min: 0.1,
             max: 50,
            },


        ];
        setupSliders(sliderDef);
        

        
    };

    console.log("Done on load");
});

// take the slide defs and produce an array
function randomSettings(sliderDef) {
    return sliderDef.map( function(def) {
        var range = def.max - def.min;
        return Math.random() * range + def.min;
    });
}

function setupSliders(sliderDef) {
    var sliderPanel = new Interface.Panel({ container:document.querySelector("#sliderpanel") });
    var width = 1.0 / sliderDef.length;
    var sliders = sliderDef.map( function(def,i) {
        var slider = new Interface.Slider({
            target: def.target, key:def.key,
            label: def.name || def.key,
            min: def.min,
            max: def.max,
            bounds:[width*i,0,width,1.0],
            isVertical : true,
        });
        return slider;
    });
    sliderPanel.add(...sliders);
    sd = sliderDef;
    console.log("Sliders added!");
    
    /* stolen from http://www.charlie-roberts.com/interface/ by Charlie Roberts */
    var a = new Interface.Panel({ container:("#multibuttonpanel") });
    var settings = Array(sliderDef.length);
    settings.fill([]);
    settings = settings.map( function(i) { return randomSettings( sliderDef ); } );
    console.log(sliderDef.length);
    console.log(settings);
    var multiButton = new Interface.MultiButton({
        rows:2, columns:sliderDef.length,
        bounds:[.0,.0,1.0,.8],
        onvaluechange : function(row, col, value) {            
            if (row == 0) {
                // set
                var newSettings = sliderDef.map(function(def) {
                    return def.target[def.key];
                });
                settings[col] = newSettings;
                multiButtonLabel.setValue("Storing "+newSettings.join(","));
            } else {
                // retrieve
                var ourSettings = settings[col];
                if (ourSettings.length != sliderDef.length) {
                    multiButtonLabel.setValue("Nothing set! Nothing loaded!");
                    return;
                }
                var newSettings = sliderDef.map(function(def,i) {
                    def.target[def.key] = ourSettings[i];
                    sliders[i].setValue( ourSettings[i] );
                    return def.target[def.key];
                });
                multiButtonLabel.setValue("Loading "+newSettings.join(","));
            }
        },
    });
    multiButton.mode = "contact";
    console.log(multiButton);
    var multiButtonLabel = new Interface.Label({ 
        bounds:[.05,.9, .9, .1],
        hAlign:"left",
        value:""
    });
    
    a.background = 'black';
    a.add(multiButton, multiButtonLabel);

    console.log("Store/Load Added");

};

function oldSetupSliders(clipMul,clampMul,sinOsc) {
    
    var sliderPanel = new Interface.Panel({ container:document.querySelector("#sliderpanel") });
    
    
    var mulSlider = new Interface.Slider({
        target: clipMul, key:1,
        label:'Multiply',
        min: 0, max: 10.0,
        bounds:[0.05,0.05,0.25,0.9],
        isVertical : true,
    });
    var mixSlider = new Interface.Slider({
        label:'Mix',
        min: 0, max: 1.0,
        bounds:[0.3,0.05,.25,0.9],
        isVertical : true,
        onvaluechange : function() {
            var value = this.value;
            console.log(value);
            //console.log(this);
            clampMul[1] = value;
            sinOsc.amp = 1.0 - value;
        }
    });


    
    sliderPanel.background = 'black';
    sliderPanel.add(mulSlider,mixSlider);

};

    </script>        
  </body>
</html>
